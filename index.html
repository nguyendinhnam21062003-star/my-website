<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách tài liệu</title>
  <style>
    :root {
      --bd: #e5e7eb;
      --muted: #6b7280;
      --chip: #f3f4f6;
      --hl-subject-bg: #fff7d6;
      --hl-price-bg: #e8fff0;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, sans-serif;
      margin: 24px;
      background: #fff;
      padding-bottom: 40px;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 20px;
    }
    .search-wrap {
      display: grid;
      gap: 10px;
      grid-template-columns: 1fr 1fr;
      max-width: 880px;
      margin: 12px 0 16px;
    }
    .search {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--bd);
      border-radius: 10px;
    }
    @media (max-width: 720px) {
      .search-wrap {
        grid-template-columns: 1fr;
      }
    }
    .cards {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
    .card {
      border: 1px solid var(--bd);
      border-radius: 14px;
      background: #fff;
      display: flex;
      flex-direction: column;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
      padding: 14px;
      font-size: 14px;
    }
    .title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .row-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 12px;
      margin-bottom: 6px;
    }
    .label-inline {
      color: var(--muted);
      white-space: nowrap;
    }
    .hl-subject {
      background: var(--hl-subject-bg);
      border-radius: 6px;
      padding: 2px 6px;
      font-weight: 600;
    }
    .hl-price {
      background: var(--hl-price-bg);
      border-radius: 6px;
      padding: 2px 6px;
      font-weight: 700;
    }
    .btn-view {
      font-size: 14px;
      color: #2563eb;
      text-decoration: none;
    }
    @media (max-width: 480px) {
      .row-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>Danh sách tài liệu</h1>
  <div class="search-wrap">
    <input class="search" id="qName" placeholder="Tìm theo tên tài liệu..." />
    <input class="search" id="qSubject" placeholder="Tìm theo môn học..." />
  </div>
  <div id="cards" class="cards" aria-live="polite"></div>
  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRL7VwTAlQldOBxOR3arotJCVv2fWLmoB3Hr6WslMdS2z_8iHM5jBnp-nK0Wvf5Ko90TLCuxgxoLihT/pub?gid=759690707&single=true&output=csv";
    const cards = document.getElementById("cards");
    const qName = document.getElementById("qName");
    const qSubject = document.getElementById("qSubject");
    let dataRows = [];
    fetch(CSV_URL)
      .then(r => r.text())
      .then(text => {
        const rows = parseCSV(text);
        if (!rows.length) return;
        const body = rows.slice(1);
        const C=2, D=3, E=4, F=5, G=6, H=7;
        dataRows = body.map(row => ({
          ten: getCell(row, C),
          monHoc: getCell(row, D),
          lienHe: getCell(row, E),
          giaBan: getCell(row, F),
          ghiChu: getCell(row, G),
          hinhAnh: getCell(row, H)
        })).filter(r => (r.ten||'').trim() !== '');
        render(dataRows);
      })
      .catch(err => {
        console.error(err);
        cards.innerHTML = `<div class="muted">Không tải được dữ liệu CSV.</div>`;
      });
    function parseCSV(text){
      const rows=[]; let row=[]; let cur=''; let inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(inQ){
          if(c==='"'){ if(n==='"'){cur+='"'; i++;} else inQ=false; }
          else cur+=c;
        }else{
          if(c==='"') inQ=true;
          else if(c===','){ row.push(cur); cur=''; }
          else if(c==='\r'){}
          else if(c==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
          else cur+=c;
        }
      }
      row.push(cur); rows.push(row);
      return rows.filter(r => r.some(cell => (cell||'').trim()!==''));
    }
    const getCell=(r,i)=> (i>=0 && i<r.length ? r[i] : '');
    function escapeHTML(s){return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}
    function nl2br(s){return (s||'').replace(/\r?\n/g,'<br>')}
    function extractLinks(s){ return (s||'').match(/https?:\/\/\S+/g) || [] }
    function formatContact(s){
      const raw=s||'';
      const email=raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
      const phone=raw.match(/(\+?\d[\d\s().-]{6,}\d)/);
      const parts=[];
      if(email) parts.push(`<a href="mailto:${email[0]}">${escapeHTML(email[0])}</a>`);
      if(phone) parts.push(`<a href="tel:${phone[0].replace(/[^\d+]/g,'')}">${escapeHTML(phone[0])}</a>`);
      if(!parts.length) return escapeHTML(raw);
      const extra=raw.replace(email?.[0]||'','').replace(phone?.[0]||'','').trim();
      return parts.join(' · ') + (extra?` <span class="muted">${escapeHTML(extra)}</span>`:'');
    }
    function formatPrice(s){
      const num=parseInt(String(s||'').replace(/[^\d]/g,''),10);
      const out=Number.isFinite(num)? num.toLocaleString('vi-VN')+' ₫' : (s||'');
      return `<span class="hl-price">${escapeHTML(out)}</span>`;
    }
    function render(rows){
      const nameTerm=(qName.value||'').toLowerCase().trim();
      const subjectTerm=(qSubject.value||'').toLowerCase().trim();
      const filtered = rows.filter(r=>{
        const okName=!nameTerm || (r.ten||'').toLowerCase().includes(nameTerm);
        const okSubject=!subjectTerm || (r.monHoc||'').toLowerCase().includes(subjectTerm);
        return okName && okSubject;
      });
      if(!filtered.length){
        cards.innerHTML = `<div class="muted">Không có kết quả.</div>`;
        return;
      }
      cards.innerHTML = filtered.map(r=>{
        const links = extractLinks(r.hinhAnh);
        const link = links[0] || "#";
        return `
          <article class="card">
            <div class="title">${escapeHTML(r.ten)}</div>
            <div class="row-grid">
              <div><span class="label-inline">Môn học:</span> <span class="hl-subject">${escapeHTML(r.monHoc)}</span></div>
              <div><span class="label-inline">Giá bán:</span> ${formatPrice(r.giaBan)}</div>
              <div><span class="label-inline">Liên hệ:</span> ${formatContact(r.lienHe)}</div>
              <div><a class="btn-view" href="${escapeHTML(link)}" target="_blank" rel="noopener">Xem hình ảnh &gt;</a></div>
            </div>
            ${r.ghiChu ? `<div class="row-grid"><div><span class="label-inline">Ghi chú:</span> ${nl2br(escapeHTML(r.ghiChu))}</div></div>`:''}
          </article>
        `;
      }).join('');
    }
    qName.addEventListener("input", ()=>render(dataRows));
    qSubject.addEventListener("input", ()=>render(dataRows));
  </script>
</body>
</html>
